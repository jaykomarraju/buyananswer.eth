{"version":3,"file":"react-collapsed.umd.js","sources":["../src/utils.ts","../src/index.ts"],"sourcesContent":["import * as React from 'react'\nimport {\n  RefObject,\n  useState,\n  useRef,\n  useEffect,\n  useCallback,\n  useLayoutEffect,\n} from 'react'\nimport warning from 'tiny-warning'\nimport type { AssignableRef } from './types'\n\ntype AnyFunction = (...args: any[]) => unknown\n\n// eslint-disable-next-line @typescript-eslint/no-empty-function\nexport const noop = (): void => {}\n\nexport function getElementHeight(\n  el: RefObject<HTMLElement> | { current?: { scrollHeight: number } }\n): string | number {\n  if (!el?.current) {\n    warning(\n      true,\n      `useCollapse was not able to find a ref to the collapse element via \\`getCollapseProps\\`. Ensure that the element exposes its \\`ref\\` prop. If it exposes the ref prop under a different name (like \\`innerRef\\`), use the \\`refKey\\` property to change it. Example:\n\n{...getCollapseProps({refKey: 'innerRef'})}`\n    )\n    return 'auto'\n  }\n  return el.current.scrollHeight\n}\n\n// Helper function for render props. Sets a function to be called, plus any additional functions passed in\nexport const callAll =\n  (...fns: AnyFunction[]) =>\n  (...args: any[]): void =>\n    fns.forEach((fn) => fn && fn(...args))\n\n// https://github.com/mui-org/material-ui/blob/da362266f7c137bf671d7e8c44c84ad5cfc0e9e2/packages/material-ui/src/styles/transitions.js#L89-L98\nexport function getAutoHeightDuration(height: number | string): number {\n  if (!height || typeof height === 'string') {\n    return 0\n  }\n\n  const constant = height / 36\n\n  // https://www.wolframalpha.com/input/?i=(4+%2B+15+*+(x+%2F+36+)+**+0.25+%2B+(x+%2F+36)+%2F+5)+*+10\n  return Math.round((4 + 15 * constant ** 0.25 + constant / 5) * 10)\n}\n\nexport function assignRef<RefValueType = any>(\n  ref: AssignableRef<RefValueType> | null | undefined,\n  value: any\n) {\n  if (ref == null) return\n  if (typeof ref === 'function') {\n    ref(value)\n  } else {\n    try {\n      ref.current = value\n    } catch (error) {\n      throw new Error(`Cannot assign value \"${value}\" to ref \"${ref}\"`)\n    }\n  }\n}\n\n/**\n * Passes or assigns a value to multiple refs (typically a DOM node). Useful for\n * dealing with components that need an explicit ref for DOM calculations but\n * also forwards refs assigned by an app.\n *\n * @param refs Refs to fork\n */\nexport function mergeRefs<RefValueType = any>(\n  ...refs: (AssignableRef<RefValueType> | null | undefined)[]\n) {\n  if (refs.every((ref) => ref == null)) {\n    return null\n  }\n  return (node: any) => {\n    refs.forEach((ref) => {\n      assignRef(ref, node)\n    })\n  }\n}\n\nexport function useControlledState(\n  isExpanded?: boolean,\n  defaultExpanded?: boolean\n): [boolean, React.Dispatch<React.SetStateAction<boolean>>] {\n  const [stateExpanded, setStateExpanded] = useState(defaultExpanded || false)\n  const initiallyControlled = useRef(isExpanded != null)\n  const expanded = initiallyControlled.current\n    ? (isExpanded as boolean)\n    : stateExpanded\n  const setExpanded = useCallback(\n    (n: boolean | ((prev: boolean) => boolean)) => {\n      if (!initiallyControlled.current) {\n        setStateExpanded(n)\n      }\n    },\n    []\n  )\n\n  useEffect(() => {\n    warning(\n      !(initiallyControlled.current && isExpanded == null),\n      'useCollapse is changing from controlled to uncontrolled. useCollapse should not switch from controlled to uncontrolled (or vice versa). Decide between using a controlled or uncontrolled collapse for the lifetime of the component. Check the `isExpanded` prop.'\n    )\n    warning(\n      !(!initiallyControlled.current && isExpanded != null),\n      'useCollapse is changing from uncontrolled to controlled. useCollapse should not switch from uncontrolled to controlled (or vice versa). Decide between using a controlled or uncontrolled collapse for the lifetime of the component. Check the `isExpanded` prop.'\n    )\n  }, [isExpanded])\n\n  return [expanded, setExpanded]\n}\n\nexport function useEffectAfterMount(\n  cb: () => void,\n  dependencies: unknown[]\n): void {\n  const justMounted = useRef(true)\n  // eslint-disable-next-line consistent-return\n  useEffect(() => {\n    if (!justMounted.current) {\n      return cb()\n    }\n    justMounted.current = false\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, dependencies)\n}\n\n/**\n * Taken from Reach\n * https://github.com/reach/reach-ui/blob/d2b88c50caf52f473a7d20a4493e39e3c5e95b7b/packages/auto-id\n *\n * Autogenerate IDs to facilitate WAI-ARIA and server rendering.\n *\n * Note: The returned ID will initially be `null` and will update after a\n * component mounts. Users may need to supply their own ID if they need\n * consistent values for SSR.\n *\n * @see Docs https://reach.tech/auto-id\n */\nconst useIsomorphicLayoutEffect =\n  typeof window !== 'undefined' ? useLayoutEffect : useEffect\nlet serverHandoffComplete = false\nlet id = 0\nconst genId = () => ++id\nexport function useUniqueId(idFromProps?: string | null) {\n  /*\n   * If this instance isn't part of the initial render, we don't have to do the\n   * double render/patch-up dance. We can just generate the ID and return it.\n   */\n  const initialId = idFromProps || (serverHandoffComplete ? genId() : null)\n\n  const [id, setId] = useState(initialId)\n\n  useIsomorphicLayoutEffect(() => {\n    if (id === null) {\n      /*\n       * Patch the ID after render. We do this in `useLayoutEffect` to avoid any\n       * rendering flicker, though it'll make the first render slower (unlikely\n       * to matter, but you're welcome to measure your app and let us know if\n       * it's a problem).\n       */\n      setId(genId())\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [])\n\n  useEffect(() => {\n    if (serverHandoffComplete === false) {\n      /*\n       * Flag all future uses of `useId` to skip the update dance. This is in\n       * `useEffect` because it goes after `useLayoutEffect`, ensuring we don't\n       * accidentally bail out of the patch-up dance prematurely.\n       */\n      serverHandoffComplete = true\n    }\n  }, [])\n  return id != null ? String(id) : undefined\n}\n\n// Workaround for https://github.com/webpack/webpack/issues/14814\nconst maybeReactUseId: undefined | (() => string) = (React as any)['useId' + '']\nexport function useId(idOverride?: string): string | undefined {\n  if (maybeReactUseId !== undefined) {\n    const reactId = maybeReactUseId()\n    return idOverride ?? reactId\n  }\n  return useUniqueId(idOverride)\n}\n\nexport function usePaddingWarning(element: RefObject<HTMLElement>): void {\n  // @ts-ignore\n  let warn = (el?: RefObject<HTMLElement>): void => {}\n\n  if (process.env.NODE_ENV !== 'production') {\n    warn = (el) => {\n      if (!el?.current) {\n        return\n      }\n      const { paddingTop, paddingBottom } = window.getComputedStyle(el.current)\n      const hasPadding =\n        (paddingTop && paddingTop !== '0px') ||\n        (paddingBottom && paddingBottom !== '0px')\n\n      warning(\n        !hasPadding,\n        'react-collapsed: Padding applied to the collapse element will cause the animation to break and not perform as expected. To fix, apply equivalent padding to the direct descendent of the collapse element.'\n      )\n    }\n  }\n\n  useEffect(() => {\n    warn(element)\n  }, [element])\n}\n","import { useState, useRef, TransitionEvent, CSSProperties } from 'react'\nimport { flushSync } from 'react-dom'\nimport raf from 'raf'\nimport {\n  noop,\n  callAll,\n  getElementHeight,\n  getAutoHeightDuration,\n  mergeRefs,\n  usePaddingWarning,\n  useEffectAfterMount,\n  useControlledState,\n  useId,\n} from './utils'\nimport {\n  UseCollapseInput,\n  UseCollapseOutput,\n  GetCollapsePropsOutput,\n  GetCollapsePropsInput,\n  GetTogglePropsOutput,\n  GetTogglePropsInput,\n} from './types'\n\nconst easeInOut = 'cubic-bezier(0.4, 0, 0.2, 1)'\n\nexport default function useCollapse({\n  duration,\n  easing = easeInOut,\n  collapseStyles = {},\n  expandStyles = {},\n  onExpandStart = noop,\n  onExpandEnd = noop,\n  onCollapseStart = noop,\n  onCollapseEnd = noop,\n  isExpanded: configIsExpanded,\n  defaultExpanded = false,\n  hasDisabledAnimation = false,\n  ...initialConfig\n}: UseCollapseInput = {}): UseCollapseOutput {\n  const [isExpanded, setExpanded] = useControlledState(\n    configIsExpanded,\n    defaultExpanded\n  )\n  const uniqueId = useId()\n  const el = useRef<HTMLElement | null>(null)\n  usePaddingWarning(el)\n  const collapsedHeight = `${initialConfig.collapsedHeight || 0}px`\n  const collapsedStyles = {\n    display: collapsedHeight === '0px' ? 'none' : 'block',\n    height: collapsedHeight,\n    overflow: 'hidden',\n  }\n  const [styles, setStylesRaw] = useState<CSSProperties>(\n    isExpanded ? {} : collapsedStyles\n  )\n  const setStyles = (newStyles: {} | ((oldStyles: {}) => {})): void => {\n    // We rely on reading information from layout\n    // at arbitrary times, so ensure all style changes\n    // happen before we might attempt to read them.\n    flushSync(() => {\n      setStylesRaw(newStyles)\n    })\n  }\n  const mergeStyles = (newStyles: {}): void => {\n    setStyles((oldStyles) => ({ ...oldStyles, ...newStyles }))\n  }\n\n  function getTransitionStyles(height: number | string): CSSProperties {\n    if (hasDisabledAnimation) {\n      return {}\n    }\n    const _duration = duration || getAutoHeightDuration(height)\n    return {\n      transition: `height ${_duration}ms ${easing}`,\n    }\n  }\n\n  useEffectAfterMount(() => {\n    if (isExpanded) {\n      raf(() => {\n        onExpandStart()\n        mergeStyles({\n          ...expandStyles,\n          willChange: 'height',\n          display: 'block',\n          overflow: 'hidden',\n        })\n        raf(() => {\n          const height = getElementHeight(el)\n          mergeStyles({\n            ...getTransitionStyles(height),\n            height,\n          })\n        })\n      })\n    } else {\n      raf(() => {\n        onCollapseStart()\n        const height = getElementHeight(el)\n        mergeStyles({\n          ...collapseStyles,\n          ...getTransitionStyles(height),\n          willChange: 'height',\n          height,\n        })\n        raf(() => {\n          mergeStyles({\n            height: collapsedHeight,\n            overflow: 'hidden',\n          })\n        })\n      })\n    }\n  }, [isExpanded, collapsedHeight])\n\n  const handleTransitionEnd = (e: TransitionEvent): void => {\n    // Sometimes onTransitionEnd is triggered by another transition,\n    // such as a nested collapse panel transitioning. But we only\n    // want to handle this if this component's element is transitioning\n    if (e.target !== el.current || e.propertyName !== 'height') {\n      return\n    }\n\n    // The height comparisons below are a final check before\n    // completing the transition\n    // Sometimes this callback is run even though we've already begun\n    // transitioning the other direction\n    // The conditions give us the opportunity to bail out,\n    // which will prevent the collapsed content from flashing on the screen\n    if (isExpanded) {\n      const height = getElementHeight(el)\n\n      // If the height at the end of the transition\n      // matches the height we're animating to,\n      if (height === styles.height) {\n        setStyles({})\n      } else {\n        // If the heights don't match, this could be due the height\n        // of the content changing mid-transition\n        mergeStyles({ height })\n      }\n\n      onExpandEnd()\n\n      // If the height we should be animating to matches the collapsed height,\n      // it's safe to apply the collapsed overrides\n    } else if (styles.height === collapsedHeight) {\n      setStyles(collapsedStyles)\n      onCollapseEnd()\n    }\n  }\n\n  function getToggleProps({\n    disabled = false,\n    onClick = noop,\n    ...rest\n  }: GetTogglePropsInput = {}): GetTogglePropsOutput {\n    return {\n      type: 'button',\n      role: 'button',\n      id: `react-collapsed-toggle-${uniqueId}`,\n      'aria-controls': `react-collapsed-panel-${uniqueId}`,\n      'aria-expanded': isExpanded,\n      tabIndex: 0,\n      disabled,\n      ...rest,\n      onClick: disabled ? noop : callAll(onClick, () => setExpanded((n) => !n)),\n    }\n  }\n\n  function getCollapseProps({\n    style = {},\n    onTransitionEnd = noop,\n    refKey = 'ref',\n    ...rest\n  }: GetCollapsePropsInput = {}): GetCollapsePropsOutput {\n    const theirRef: any = rest[refKey]\n    return {\n      id: `react-collapsed-panel-${uniqueId}`,\n      'aria-hidden': !isExpanded,\n      ...rest,\n      [refKey]: mergeRefs(el, theirRef),\n      onTransitionEnd: callAll(handleTransitionEnd, onTransitionEnd),\n      style: {\n        boxSizing: 'border-box',\n        // additional styles passed, e.g. getCollapseProps({style: {}})\n        ...style,\n        // style overrides from state\n        ...styles,\n      },\n    }\n  }\n\n  return {\n    getToggleProps,\n    getCollapseProps,\n    isExpanded,\n    setExpanded,\n  }\n}\n"],"names":["noop","getElementHeight","el","current","scrollHeight","warning","callAll","forEach","fn","assignRef","ref","value","error","Error","useIsomorphicLayoutEffect","window","useLayoutEffect","useEffect","serverHandoffComplete","id","genId","maybeReactUseId","React","element","warn","duration","easing","collapseStyles","expandStyles","onExpandStart","onExpandEnd","onCollapseStart","onCollapseEnd","configIsExpanded","isExpanded","defaultExpanded","hasDisabledAnimation","initialConfig","useState","stateExpanded","setStateExpanded","initiallyControlled","useRef","expanded","setExpanded","useCallback","n","useControlledState","uniqueId","undefined","idFromProps","initialId","setId","String","useUniqueId","process","env","NODE_ENV","getComputedStyle","paddingTop","paddingBottom","cb","dependencies","justMounted","collapsedHeight","collapsedStyles","display","height","overflow","styles","setStylesRaw","setStyles","newStyles","flushSync","mergeStyles","oldStyles","getTransitionStyles","_duration","constant","Math","round","getAutoHeightDuration","transition","raf","willChange","handleTransitionEnd","e","target","propertyName","getToggleProps","disabled","onClick","rest","type","role","tabIndex","getCollapseProps","style","onTransitionEnd","refKey","refs","every","node","mergeRefs","boxSizing"],"mappings":"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"}